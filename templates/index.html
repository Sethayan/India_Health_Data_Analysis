<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>India Health Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    h1 {
      color: #0d6efd;
      margin: 30px 0;
      text-align: center;
      font-weight: bold;
    }

    .chart-container {
      position: relative;
      width: 85%;
      height: 700px;
      margin: 0 auto;
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    select, input {
      width: 180px;
      height: 38px;
      border-radius: 8px;
      border: 1px solid #ccc;
      padding: 5px;
    }

    .stats-card {
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      text-align: center;
    }

    .stats-container {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 20px auto;
      max-width: 800px;
      flex-wrap: wrap;
    }

    .stats-card h5 {
      color: #0d6efd;
      font-size: 18px;
    }

    .stats-card p {
      font-size: 22px;
      font-weight: bold;
      margin: 0;
    }

    button {
      background-color: #0d6efd;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 7px 15px;
      cursor: pointer;
    }

    button:hover {
      background-color: #084298;
    }
  </style>
</head>
<body>

  <h1>India Health Dashboard (1985–2023)</h1>

  <!-- Filter Controls -->
  <div class="controls">
    <label class="fw-semibold">Indicator:</label>
    <select id="indicatorSelect">
      <option value="life">Life Expectancy</option>
      <option value="imr">Infant Mortality Rate</option>
      <option value="mmr">Maternal Mortality Ratio</option>
      <option value="combined">Combined Comparison</option>
    </select>

    <label class="fw-semibold">From:</label>
    <input type="number" id="startYear" min="1985" max="2023" value="1985">

    <label class="fw-semibold">To:</label>
    <input type="number" id="endYear" min="1985" max="2023" value="2023">

    <button id="applyFilter">Apply Filter</button>
  </div>

  <!-- Stats Section -->
  <div class="stats-container">
    <div class="stats-card">
      <h5>Change per Year (%)</h5>
      <p id="rateValue">0</p>
    </div>
  </div>

  <!-- Chart Container -->
  <div class="chart-container">
    <canvas id="mainChart"></canvas>
  </div>

  <script>
  // Data from Flask
  const years = {{ years | tojson }};
  const life_exp = {{ life_exp | tojson }};
  const infant_mortality = {{ infant_mortality | tojson }};
  const maternal_mortality = {{ maternal_mortality | tojson }};

  const ctx = document.getElementById('mainChart').getContext('2d');
  let chart;

  // Calculate % change per year
  function calcRate(data) {
    const first = data[0];
    const last = data[data.length - 1];
    const yearsCount = data.length - 1;
    const rate = ((last - first) / first / yearsCount) * 100;
    return rate.toFixed(2);
  }

  function updateRate(data) {
    const rate = calcRate(data);
    const symbol = rate >= 0 ? "↑" : "↓";
    document.getElementById("rateValue").innerText = `${symbol} ${Math.abs(rate)}% per year`;
    document.getElementById("rateValue").style.color = rate >= 0 ? "green" : "red";
  }

  // Update rates for combined chart using filtered data
function updateCombinedRates(filteredLife, filteredIMR, filteredMMR) {
    const rateLife = calcRate(filteredLife);
    const rateIMR = calcRate(filteredIMR);
    const rateMMR = calcRate(filteredMMR);

    document.querySelector(".stats-container").innerHTML = `
      <div class="stats-card" style="color: ${rateLife >= 0 ? 'green' : 'red'}">
        <h5>Life Expectancy</h5>
        <p>${rateLife >= 0 ? '↑' : '↓'} ${Math.abs(rateLife)}%/yr</p>
      </div>
      <div class="stats-card" style="color: ${rateIMR >= 0 ? 'green' : 'red'}">
        <h5>Infant Mortality</h5>
        <p>${rateIMR >= 0 ? '↑' : '↓'} ${Math.abs(rateIMR)}%/yr</p>
      </div>
      <div class="stats-card" style="color: ${rateMMR >= 0 ? 'green' : 'red'}">
        <h5>Maternal Mortality</h5>
        <p>${rateMMR >= 0 ? '↑' : '↓'} ${Math.abs(rateMMR)}%/yr</p>
      </div>
    `;
}


  // Filter dataset based on year range
  function filterDataByYear(start, end) {
    const startIndex = years.indexOf(String(start));
    const endIndex = years.indexOf(String(end));
    return {
      filteredYears: years.slice(startIndex, endIndex + 1),
      life: life_exp.slice(startIndex, endIndex + 1),
      imr: infant_mortality.slice(startIndex, endIndex + 1),
      mmr: maternal_mortality.slice(startIndex, endIndex + 1)
    };
  }

  // Create chart
  function createChart(type, start=1985, end=2023) {
    if (chart) chart.destroy();

    const { filteredYears, life, imr, mmr } = filterDataByYear(start, end);
    let config;

    document.querySelector(".stats-container").innerHTML =
      `<div class="stats-card"><h5>Change per Year (%)</h5><p id="rateValue">0</p></div>`;

    if (type === "combined") {
      updateCombinedRates(life, imr, mmr);
      config = {
        type: "bar",
        data: {
          labels: filteredYears,
          datasets: [
            {
              type: "line",
              label: "Life Expectancy",
              data: life,
              borderColor: "rgba(54, 162, 235, 1)",
              backgroundColor: "rgba(54, 162, 235, 0.3)",
              yAxisID: "y1",
              fill: false,
              tension: 0.4
            },
            {
              type: "bar",
              label: "Infant Mortality",
              data: imr,
              backgroundColor: "rgba(255, 99, 132, 0.6)",
              yAxisID: "y2"
            },
            {
              type: "bar",
              label: "Maternal Mortality",
              data: mmr,
              backgroundColor: "rgba(255, 206, 86, 0.7)",
              yAxisID: "y2"
            }
          ]
        },
        options: {
          plugins: {
            title: { display: true, text: "Combined View: Life Expectancy, IMR & MMR", font: { size: 20 } },
            legend: { position: "top" }
          },
          scales: {
            y1: {
              type: "linear",
              position: "left",
              title: { display: true, text: "Life Expectancy (Years)" },
              beginAtZero: false
            },
            y2: {
              type: "linear",
              position: "right",
              title: { display: true, text: "Mortality Rates" },
              beginAtZero: true,
              grid: { drawOnChartArea: false }
            }
          }
        }
      };
    } 
    else {
      let label, color, data;
      if (type === "life") { label = "Life Expectancy (Years)"; color = "rgba(54, 162, 235, 1)"; data = life; }
      if (type === "imr") { label = "Infant Mortality (per 1,000 births)"; color = "rgba(255, 99, 132, 1)"; data = imr; }
      if (type === "mmr") { label = "Maternal Mortality (per 100,000)"; color = "rgba(255, 159, 64, 1)"; data = mmr; }

      updateRate(data);
      config = {
        type: type === "imr" ? "bar" : "line",
        data: {
          labels: filteredYears,
          datasets: [{
            label,
            data,
            borderColor: color,
            backgroundColor: color.replace('1)', '0.3)'),
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          plugins: { title: { display: true, text: label, font: { size: 20 } } },
          scales: { y: { beginAtZero: false } }
        }
      };
    }

    chart = new Chart(ctx, config);
  }

  // Initialize
  createChart("life");

  document.getElementById("indicatorSelect").addEventListener("change", function () {
    const start = document.getElementById("startYear").value;
    const end = document.getElementById("endYear").value;
    createChart(this.value, start, end);
  });

  document.getElementById("applyFilter").addEventListener("click", () => {
    const type = document.getElementById("indicatorSelect").value;
    const start = document.getElementById("startYear").value;
    const end = document.getElementById("endYear").value;
    createChart(type, start, end);
  });
</script>

</body>
</html>
